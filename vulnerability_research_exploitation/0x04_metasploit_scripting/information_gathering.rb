require 'msf/core'

class MetasploitModule < Msf::Post
  include Msf::Post::Windows::Sysinfo
  include Msf::Post::Windows::Net
  include Msf::Post::Windows::UserProfiles
  include Msf::Post::Windows::Process

  def initialize(info = {})
    super(update_info(info,
      'Name'         => 'Windows Information Gathering',
      'Description'  => 'Gathers OS, user, network, and process info from a target Windows system',
      'Author'       => ['YourName'],
      'License'      => MSF_LICENSE,
      'Platform'     => ['win'],
      'SessionTypes' => ['meterpreter']
    ))

    register_options([
      OptInt.new('SESSION', [true, 'The session ID to gather information from'])
    ])
  end

  def run
    print_status("Gathering system information from #{session.session_host}")
    gather_system_info
    gather_user_info
    gather_network_info
    gather_running_processes
  end

  def gather_system_info
    os = sysinfo['OS']
    comp = sysinfo['Computer']
    print_good("OS: #{os}")
    print_good("Computer: #{comp}")
  end

  def gather_user_info
    user = getuid
    print_good("User: #{user}")
  end

  def gather_network_info
    interfaces = session.net.config.interfaces
    interfaces.each do |iface|
      iface_name = iface.name
      ip = iface.ip_address
      netmask = iface.netmask
      print_good("Interface: #{iface_name}, IP: #{ip}, Netmask: #{netmask}")
    end
  end

  def gather_running_processes
    processes = session.sys.process.get_processes
    processes.each do |proc|
      print_good("Process #{proc['pid']} - #{proc['name']}")
    end
  end
end
